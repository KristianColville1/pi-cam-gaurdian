<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebPageTest</title>
    <style>
        body {
            box-sizing: 0;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <h1>WebPageTest</h1>
    <div style="display:flex;width:100%;height:100%;">
        <div style="width: 50%">
            <div
                style="margin-top:4rem;margin-bottom:4rem;position:relative;width:100%;height:0;padding-bottom:56.25%;overflow:hidden;box-shadow: rgba(50, 50, 93, 0.25) 0px 50px 100px -20px, rgba(0, 0, 0, 0.3) 0px 30px 60px -30px;">
                <iframe src="http://145.241.195.101:8889/cam"
                    style="position:absolute;top:0;left:0;width:100%;height:100%; border-radius: 0.5rem;overflow:hidden;"></iframe>
            </div>
        </div>
        <div style="width: 50%; padding: 2rem;">
            <h2>Sense HAT Sensor Data</h2>
            <table style="width: 100%; border-collapse: collapse; margin-top: 2rem; font-family: Arial, sans-serif;">
                <thead>
                    <tr style="background-color: #f3f4f6;">
                        <th style="padding: 0.75rem; text-align: left; border: 1px solid #d1d5db;">Sensor</th>
                        <th style="padding: 0.75rem; text-align: left; border: 1px solid #d1d5db;">Value</th>
                        <th style="padding: 0.75rem; text-align: left; border: 1px solid #d1d5db;">Unit</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">Temperature (Humidity)</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;" id="temp_humidity">--</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">°C</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">Temperature (Pressure)</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;" id="temp_pressure">--</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">°C</td>
                    </tr>
                    <tr>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">Humidity</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;" id="humidity">--</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">%</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">Pressure</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;" id="pressure">--</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">mbar</td>
                    </tr>
                    <tr>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">Pitch</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;" id="pitch">--</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">°</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">Roll</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;" id="roll">--</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">°</td>
                    </tr>
                    <tr>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">Yaw</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;" id="yaw">--</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">°</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">Acceleration X</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;" id="accel_x">--</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">g</td>
                    </tr>
                    <tr>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">Acceleration Y</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;" id="accel_y">--</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">g</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">Acceleration Z</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;" id="accel_z">--</td>
                        <td style="padding: 0.75rem; border: 1px solid #d1d5db;">g</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <script>
        // MQTT Configuration
        const MQTT_BROKER = "145.241.195.101";
        const MQTT_PORT = 9001;  // WebSocket port
        const MQTT_TOPIC = "sensors/metrics";
        
        // Wait for Paho library to load
        if (typeof Paho === 'undefined' || typeof Paho.Client === 'undefined') {
            console.error('Paho MQTT library failed to load');
        }
        
        // Create MQTT client (correct syntax is Paho.Client, not Paho.MQTT.Client)
        const client = new Paho.Client(MQTT_BROKER, MQTT_PORT, "web_client_" + Math.random().toString(16).substr(2, 8));
        
        // Set callback handlers
        client.onConnectionLost = function(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.error("MQTT connection lost: " + responseObject.errorMessage);
            }
        };
        
        client.onMessageArrived = function(message) {
            try {
                const metrics = JSON.parse(message.payloadString);
                updateTable(metrics);
            } catch (e) {
                console.error("Error parsing MQTT message:", e);
            }
        };
        
        // Connect to MQTT broker via WebSocket
        client.connect({
            onSuccess: function() {
                console.log("Connected to MQTT broker");
                client.subscribe(MQTT_TOPIC);
            },
            onFailure: function(error) {
                console.error("Failed to connect to MQTT broker:", error.errorMessage);
            },
            useSSL: false
        });
        
        // Update table with sensor metrics
        function updateTable(metrics) {
            // Map metric keys to element IDs
            const metricMap = {
                "temp_humidity": "temp_humidity",
                "temp_pressure": "temp_pressure",
                "humidity": "humidity",
                "pressure": "pressure",
                "pitch": "pitch",
                "roll": "roll",
                "yaw": "yaw",
                "accel_x": "accel_x",
                "accel_y": "accel_y",
                "accel_z": "accel_z"
            };
            
            // Update each metric value in the table
            for (const [key, elementId] of Object.entries(metricMap)) {
                const element = document.getElementById(elementId);
                if (element && metrics[key] !== undefined) {
                    element.textContent = metrics[key];
                }
            }
        }
    </script>
</body>

</html>